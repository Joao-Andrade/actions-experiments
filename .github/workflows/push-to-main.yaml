name: Push to main
on:
  - push
  #push:
    #branches:
    #  - main

env:
  GH_TOKEN: ${{ github.token }}
  RELEASE_TYPE: simple
#  APP_NAME: 'aaaa'
#  DOCKER_REGISTRY: 'bbbb'
#  GITHUB_TOKEN: 'a'

jobs:
  get-latest-stable-release:
    name: Get current latest release version
    runs-on: ubuntu-latest
    outputs:
      prev_release: ${{ steps.prev_release.outputs.PREV_RELEASE }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Get previous release
        id: prev_release
        run: echo "PREV_RELEASE=$(gh release list | awk '$2 == "Latest"' | awk '{print $1}')" >>  $GITHUB_OUTPUT
        # get this to output


  release-please:
    runs-on: ubuntu-latest
    needs:
      - get-latest-stable-release
    permissions:
      contents: write
      pull-requests: write
    outputs:
      release_created: ${{ steps.release.outputs.release_created || false }}
      version_tag: "${{ steps.release.outputs.release_created && format('{0}.{1}.{2}',steps.release.outputs.major,steps.release.outputs.minor,steps.release.outputs.patch) || steps.package-json-version.outputs.value }}"
    steps:
    - uses: google-github-actions/release-please-action@v3
      id: release
      with:
        release-type: ${{ env.RELEASE_TYPE }}
    - name: Checkout code
      uses: actions/checkout@v3


  rollback-latest-release:
    name: Create rollback pull request
    runs-on: ubuntu-latest
    needs:
      - get-latest-stable-release
      - release-please
    #${{ needs.release-please.outputs.release_created }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Checkout to previous version
      run: echo "Previous version -> ${{ needs.get-latest-stable-release.outputs.prev_release }}"
    - name: Change branch to rollback-branch
      run: git checkout -b rollback-branch
    - name: Change version on version files
      run: |
        echo "A."
        echo "${{ env.RELEASE_TYPE }}"
    # create pull request with changes to latest good version on version.txt and stuff

